<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><title>C0de_G0lf</title><meta property="og:title" content="C0de_G0lf"><meta name=twitter:title content="C0de_G0lf"><meta name=description content="Why Understanding Your Application's Language is Important: PlaidCTF 2019"><meta property="og:description" content="Why Understanding Your Application's Language is Important: PlaidCTF 2019"><meta name=twitter:description content="Why Understanding Your Application's Language is Important: PlaidCTF 2019"><meta name=author content="Morgaine Timms"><link href=https://timms.io/logo.ico rel=icon type=image/x-icon><meta property="og:url" content="https://timms.io/blog/codegolf/"><meta property="og:type" content="website"><meta property="og:site_name" content="TimmsIO"><link rel=canonical href=https://timms.io/blog/codegolf/><link rel=stylesheet href=/style.main.min.a57edc6b2eca52225ee1ca9511ac89c208bc66969722bbf2bf796a2c17fd18a7.css media=screen></head><body><nav id=primary-nav class="navbar is-black" role=navigation aria-label="main navigation"><div class=container><div class=navbar-brand><a class=navbar-item href=https://timms.io><img src=/logo.svg alt=TimmsIO><span class="site-title is-size-4" style=padding-left:1rem;padding-right:1rem>|| TimmsIO</span></a><div role=button class="navbar-burger burger" aria-label=menu aria-expanded=false data-target=navbarMenu><span aria-hidden=true></span><span aria-hidden=true></span><span aria-hidden=true></span></div></div><div class=navbar-menu id=navbarMenu><div class=navbar-start></div><div class=navbar-end><a class=navbar-item title=About href=/#contact>About</a><div class="navbar-item has-dropdown"><a class=navbar-link title=Posts>Posts</a><div class=navbar-dropdown><a class=navbar-item title=Blog href=/categories/blog/>Blog</a>
<a class=navbar-item title=Writeups href=/categories/writeups/>Writeups</a>
<a class=navbar-item title=CTFs href=/categories/ctfs>CTFs</a><hr class=navbar-divider><a class=navbar-item title=All href=/posts>All</a></div></div><a class=navbar-item title=Projects href=/projects>Projects</a></div></div></div></nav><div class=page-blocks></div><section class="hero is-medium" style=background-image:url(/image/steve-johnson-ktf7lHuh8MM-unsplash_hu3d03a01dcc18bc5be0e67db3d8d209a6_1100123_1600x1600_fit_q75_box.jpg)><div class="container hero-body has-text-centered" style="text-shadow:-1px 0 #000,0 1px #000,1px 0 #000,0 -1px #000"><h1 class="title is-1 has-text-white">C0de_G0lf</h1></div></section><div class="columns is-gapless is-desktop"><div class=column><section class="section container content"><div class="tio-page columns is-centered"><div class="column is-four-fifths-tablet is-three-quarters-widescreen has-background-dark has-text-light"><h1 id=takeaways-from-plaidctf-2019>Takeaways from PlaidCTF 2019</h1><p>Very few developers are intentionally coding exploitable bugs into production software.
But working code doesn&rsquo;t always mean code that does what the developer intended.
A few minor misunderstandings of a language&rsquo;s std lib and internals can be disastrous.
As a former developer I&rsquo;m fascinated by the impact of language choice on security.</p><p>Exploits exist at the nexus of multiple vulnerabilities.
Defensively, we use various techniques to reduce the likelihood of vulnerabilities becoming an exploit.
But what happens when they are implemented incorrectly?</p><p>&ldquo;Can You Guess Me&rdquo; from PlaidCTF 2019 is a very concise example of the perfect storm.
The key takeaway is this: <strong>sanitising inputs is great&hellip;&hellip; if you do it right</strong></p><p>I will be ignoring the fact this was written to be intentionally vulnerable to highlight the real-world problems it showcases.</p><h2 id=acknowledgement>Acknowledgement</h2><p>The PlaidCTF was awesome and the team who put it together did a fantastic job.
I learnt a lot, tried some new things, and had loads of fun.</p><p>Working with everyone in <a href=https://ctftime.org/team/78005>CultofthePartyParrot</a> made the experience all the better.</p><h2 id=the-solution-s>The Solution(s)</h2><p>The solution writeup is <a href=/ctf/2019/plaid/can-you-guess-me/>available in a different post</a>.</p><p>&ldquo;Can You Guess Me&rdquo; is a &ldquo;Code Golf&rdquo; challenge with a twist.
By casting the input to <code>set()</code> before counting characters, only unique characters are counted.</p><p>Because of this, <code>print(vars())</code>, which appears to be too many characters, gets past the filter.</p><p>Python is a very helpful language though, so <code>help(flag)</code> (under the limit!) will tell you exactly what you want.</p><figure class=image><a href=/assets/walkthroughs/PCTF2019/cygm.png><img src=/assets/walkthroughs/PCTF2019/cygm.png></a></figure><p>Now on to the nitty-gritty:</p><h2 id=the-code>The Code</h2><p>Since this is about coding errors, looking at the code is important.
The code running the challenge was very simple:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#75715e>#! /usr/bin/env python3</span>

<span style=color:#f92672>from</span> sys <span style=color:#f92672>import</span> exit
<span style=color:#f92672>from</span> secret <span style=color:#f92672>import</span> secret_value_for_password, flag, <span style=color:#66d9ef>exec</span>

<span style=color:#66d9ef>print</span>(<span style=color:#e6db74>r</span><span style=color:#e6db74>&#34;&#34;</span>)
<span style=color:#66d9ef>print</span>(<span style=color:#e6db74>r</span><span style=color:#e6db74>&#34;&#34;</span>)
<span style=color:#66d9ef>print</span>(<span style=color:#e6db74>r</span><span style=color:#e6db74>&#34;  ____         __   __           ____                     __  __       &#34;</span>)
<span style=color:#66d9ef>print</span>(<span style=color:#e6db74>r</span><span style=color:#e6db74>&#34; / ___|__ _ _ _\ \ / /__  _   _ / ___|_   _  ___  ___ ___|  \/  | ___  &#34;</span>)
<span style=color:#66d9ef>print</span>(<span style=color:#e6db74>r</span><span style=color:#e6db74>&#34;| |   / _` | &#39;_ \ V / _ \| | | | |  _| | | |/ _ \/ __/ __| |\/| |/ _ \ &#34;</span>)
<span style=color:#66d9ef>print</span>(<span style=color:#e6db74>r</span><span style=color:#e6db74>&#34;| |__| (_| | | | | | (_) | |_| | |_| | |_| |  __/\__ \__ \ |  | |  __/ &#34;</span>)
<span style=color:#66d9ef>print</span>(<span style=color:#e6db74>r</span><span style=color:#e6db74>&#34; \____\__,_|_| |_|_|\___/ \__,_|\____|\__,_|\___||___/___/_|  |_|\___| &#34;</span>)
<span style=color:#66d9ef>print</span>(<span style=color:#e6db74>r</span><span style=color:#e6db74>&#34;                                                                       &#34;</span>)
<span style=color:#66d9ef>print</span>(<span style=color:#e6db74>r</span><span style=color:#e6db74>&#34;&#34;</span>)
<span style=color:#66d9ef>print</span>(<span style=color:#e6db74>r</span><span style=color:#e6db74>&#34;&#34;</span>)

<span style=color:#66d9ef>try</span>:
    val <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
    inp <span style=color:#f92672>=</span> input(<span style=color:#e6db74>&#34;Input value: &#34;</span>)
    count_digits <span style=color:#f92672>=</span> len(set(inp))
    <span style=color:#66d9ef>if</span> count_digits <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>10</span>:          <span style=color:#75715e># Make sure it is a number</span>
        val <span style=color:#f92672>=</span> eval(inp)
    <span style=color:#66d9ef>else</span>:
        <span style=color:#66d9ef>raise</span>

    <span style=color:#66d9ef>if</span> val <span style=color:#f92672>==</span> secret_value_for_password:
        <span style=color:#66d9ef>print</span>(flag)
    <span style=color:#66d9ef>else</span>:
        <span style=color:#66d9ef>print</span>(<span style=color:#e6db74>&#34;Nope. Better luck next time.&#34;</span>)
<span style=color:#66d9ef>except</span>:
    <span style=color:#66d9ef>print</span>(<span style=color:#e6db74>&#34;Nope. No hacking.&#34;</span>)
    exit(<span style=color:#ae81ff>1</span>)</code></pre></div><h2 id=the-problems>The Problems</h2><p>There are a few vulnerable pieces of code here.</p><p>Starting with the &ldquo;very minor&rdquo; and moving up:</p><h3 id=unused-imports>unused imports</h3><p>Fixing this won&rsquo;t drop much risk, but for completeness sake here we go.</p><p>There is an unused import called <code>exec</code>.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#f92672>from</span> secret <span style=color:#f92672>import</span> secret_value_for_password, flag, <span style=color:#66d9ef>exec</span></code></pre></div><p>Any code on a production server is a potential liability.
If it&rsquo;s not being used, don&rsquo;t put it in production.
Some modern languages won&rsquo;t even run if you include unused imports and variables.</p><h3 id=poor-sanitisation>poor sanitisation</h3><p>I very strongly <strong>DO NOT</strong> recommend doing this as the code will still be <em>vulnerable</em>, but fixing the sanitisation could prevent exploitation. In this case, you are still only one commit away from a breach.</p><p>The poorly implemented sanitisation occurs here:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#75715e># ...snip...</span>
count_digits <span style=color:#f92672>=</span> len(set(inp))
<span style=color:#66d9ef>if</span> count_digits <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>10</span>:          <span style=color:#75715e># Make sure it is a number</span>
<span style=color:#75715e># ...snip...</span></code></pre></div><p><code>count_digits</code>, as the comment suggests, is supposed to sanitise the input.
What it <em>actually</em> does is cast <code>inp</code>, a string, to a <a href=https://www.w3schools.com/python/python_sets.asp>python set</a> and count the elements in the list. A <code>set</code> can only contain unique elements, so <code>len(set(&quot;aaaaaaaaaaaaa&quot;))</code> is 1. This is what provides the &ldquo;code-golfing&rdquo; solution. It provides no benefit to the application.</p><p>Python <a href=https://docs.python.org/3.6/library/functions.html#int>provides a method for casting a string to an int</a>, and will raise an exception if the string is not numeric.
Had this been used, the application would not be exploitable.</p><h3 id=using-eval>using eval</h3><div class="columns is-widescreen is-vcentered is-centered"><div class="column is-four-fifths"><article class="message is-danger"><div class="message-header is-centered"><div class=is-size-3-widescreen><span class=icon><i class="fa fa-ban"></i></span>Exploitable Vulnerability</div></div><div class=message-body>Exploitable Vulnerability: using <code>eval()</code><br>Unless you really want to (hint: you don&rsquo;t) run code you didn&rsquo;t write, this is bad.</div></article></div></div><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#75715e># ...snip...</span>
val <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
<span style=color:#75715e># ...snip...</span>
inp <span style=color:#f92672>=</span> input(<span style=color:#e6db74>&#34;Input value: &#34;</span>)
count_digits <span style=color:#f92672>=</span> len(set(inp))
<span style=color:#66d9ef>if</span> count_digits <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>10</span>:          <span style=color:#75715e># Make sure it is a number</span>
    val <span style=color:#f92672>=</span> eval(inp)
<span style=color:#75715e># ...snip...</span></code></pre></div><p>So why write this?</p><p><code>eval()</code> is used in this code to cast a string to an integer.</p><p>It does actually do this.</p><p>It also executes whatever string it was passed.</p><p>The code passes it a string.</p><p>It is a creative way of casting a string to an int.
But applying a knowledge of Python would suggest to even the most creative developer that it could have unintentional results.</p><h2 id=putting-the-fixes-together>Putting the fixes together</h2><p>The todo-list to fix this code is:</p><ul><li>remove unused imports</li><li>properly sanitise user input</li><li>remove use of eval()</li></ul><p>That might look something like this:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#f92672>from</span> sys <span style=color:#f92672>import</span> exit
<span style=color:#f92672>from</span> secret <span style=color:#f92672>import</span> secret_value_for_password, flag
<span style=color:#75715e># ...snip...</span>
<span style=color:#66d9ef>try</span>:
    <span style=color:#75715e># cast input to integer</span>
    <span style=color:#75715e># ValueError raised if it&#39;s not numeric</span>
    <span style=color:#75715e># this effectively implements the sanitisation from the original comment</span>
    val <span style=color:#f92672>=</span> int(input(<span style=color:#e6db74>&#34;Input value: &#34;</span>))

    <span style=color:#75715e># make sure it&#39;s less than 10 digits like in the original</span>
    <span style=color:#75715e># cast the int to a str for this</span>
    <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> len(str(val)) <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>10</span>:
        <span style=color:#66d9ef>raise</span> <span style=color:#a6e22e>ValueError</span>()

    <span style=color:#66d9ef>if</span> val <span style=color:#f92672>==</span> secret_value_for_password:
        <span style=color:#66d9ef>print</span>(flag)
    <span style=color:#66d9ef>else</span>:
        <span style=color:#66d9ef>print</span>(<span style=color:#e6db74>&#34;Nope. Better luck next time.&#34;</span>)
<span style=color:#66d9ef>except</span>:
    <span style=color:#66d9ef>print</span>(<span style=color:#e6db74>&#34;Nope. No hacking.&#34;</span>)
    exit(<span style=color:#ae81ff>1</span>)</code></pre></div></div></div></section></div></div><link href=https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css rel=stylesheet integrity=sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN crossorigin=anonymous><noscript><style>.navbar-burger-toggle+.navbar-burger{margin-top:-3.5em}.navbar-burger-toggle:checked+.navbar-burger span:nth-child(1){transform:translateY(5px)rotate(45deg)}.navbar-burger-toggle:checked+.navbar-burger span:nth-child(2){opacity:0}.navbar-burger-toggle:checked+.navbar-burger span:nth-child(3){transform:translateY(-5px)rotate(-45deg)}.navbar-burger-toggle:checked~.navbar-menu{display:block}</style></noscript><script>'use strict';document.addEventListener('DOMContentLoaded',function(){var $dropdowns=getAll('.navbar-item.has-dropdown:not(.is-hoverable)');if($dropdowns.length>0){$dropdowns.forEach(function($el){$el.addEventListener('click',function(event){event.stopPropagation();$el.classList.toggle('is-active');});});document.addEventListener('click',function(event){closeDropdowns();});}
function closeDropdowns(){$dropdowns.forEach(function($el){$el.classList.remove('is-active');});}
document.addEventListener('keydown',function(event){var e=event||window.event;if(e.keyCode===27){closeDropdowns();}});var $burgers=getAll('.burger');if($burgers.length>0){$burgers.forEach(function($el){$el.addEventListener('click',function(){var target=$el.dataset.target;var $target=document.getElementById(target);$el.classList.toggle('is-active');$target.classList.toggle('is-active');});});}
function getAll(selector){return Array.prototype.slice.call(document.querySelectorAll(selector),0);}});</script><script async src="https://www.googletagmanager.com/gtag/js?id=UA-77343548-1"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','UA-77343548-1');</script></body></html>